const express = require("express");
const router = express.Router();
const Listing = require("../models/listing");
const Review = require("../models/review");
const { isLoggedIn,isAdmin } = require("../middleware/middleware");


// Add New
router.get("/listings/new", isAdmin, (req, res) => {
    res.render("listings/new.ejs");
  });
  
  // Create Listing
  router.post("/listings", isAdmin, async (req, res) => {
    const newListing = new Listing(req.body.listing);
    await newListing.save();
    res.redirect("/listings");
  });
  
  // Edit Listing
  router.get("/listings/:id/edit", isAdmin, async (req, res) => {
    let { id } = req.params;
    const listing =  Listing.findById(id);
    res.render("listings/edit.ejs", { listing });
  });
  
  // Update
  router.put("/listings/:id", isAdmin, async (req, res) => {
    let { id } = req.params;
    await Listing.findByIdAndUpdate(id, { ...req.body.listing });
    res.redirect("/listings/${id}");
  });
  
  // Delete
  router.delete("/listings/:id", isAdmin, async (req, res) => {
    let { id } = req.params;
    await Listing.findByIdAndDelete(id);
    req.flash("success", "Listing deleted successfully!");
    res.redirect("/listings");
  });
  // POST review for a specific listing
router.post("/:id/reviews", isLoggedIn, async (req, res) => {
  const { id } = req.params;
  const { rating, comment } = req.body;

  const listing = await Listing.findById(id);
  const review = new Review({
    rating,
    comment,
    author: req.user._id,
  });

  listing.reviews.push(review);
  await review.save();
  await listing.save();

  // ðŸ”¹ Update average rating
  const allReviews = await Review.find({ _id: { $in: listing.reviews } });
  const avgRating =
    allReviews.reduce((sum, r) => sum + r.rating, 0) / allReviews.length;
  listing.averageRating = avgRating.toFixed(1);
  await listing.save();

  req.flash("success", "Review added successfully!");
  res.redirect(`/listings/${id}`);
});

// DELETE review
router.delete("/:id/reviews/:reviewId", isLoggedIn, async (req, res) => {
  const { id, reviewId } = req.params;
  await Listing.findByIdAndUpdate(id, { $pull: { reviews: reviewId } });
  await Review.findByIdAndDelete(reviewId);

  // Recalculate average rating
  const listing = await Listing.findById(id).populate("reviews");
  if (listing.reviews.length > 0) {
    const avg =
      listing.reviews.reduce((sum, r) => sum + r.rating, 0) /
      listing.reviews.length;
    listing.averageRating = avg.toFixed(1);
  } else {
    listing.averageRating = 0;
  }
  await listing.save();

  req.flash("success", "Review deleted successfully!");
  res.redirect("/listings/${id}");
});
router.get("/:id", async (req, res) => {
  const { id } = req.params;
  const listing = await Listing.findById(id)
    .populate({
      path: "reviews",
      populate: { path: "author" } // optional: if you store author info
    });

  if (!listing) {
    req.flash("error", "Listing not found!");
    return res.redirect("/listings");
  }

  res.render("listings/show", { listing });
});

router.get("/", async (req, res) => {
  const listings = await Listing.find({}).populate("reviews");
  listings.forEach(listing => {
    if (listing.reviews.length > 0) {
      const avg = listing.reviews.reduce((sum, r) => sum + r.rating, 0) / listing.reviews.length;
      listing.averageRating = avg;
    } else {
      listing.averageRating = 0;
    }
  });
  res.render("listings/index", { listings });
});

module.exports = router;











// reviews 

const express = require("express");
const router = express.Router({ mergeParams: true });
const Listing = require("../models/listing");
const Review = require("../models/review");

// POST new review
router.post("/", async (req, res) => {
  const listing = await Listing.findById(req.params.id);
  const review = new Review(req.body.review);
  // optional: assign author if user login system exists
  // review.author = req.user._id;
  if (req.user) review.author = req.user._id;
  await review.save();
  listing.reviews.push(review);
  await listing.save();

  res.redirect(`/listings/${listing._id}`);
});

module.exports = router;
